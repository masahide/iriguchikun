# circle.yml
machine:
  environment:
    CHECKOUT_PATH: $HOME/$CIRCLE_PROJECT_REPONAME
  post:
    - |
      echo "export BUILD_DATE=\"`date +%FT%T%z`\"" >> ~/.circlerc;
      cat ~/.circlerc|sed 's/.*GITHUB_TOKEN.*//g'
dependencies:
  pre:
    - git tag -l 
    - go get -u github.com/alecthomas/gometalinter
    - gometalinter --install
test:
  override:
    - |
      DIR=$(git remote -v |grep '^origin\t.*\(fetch\)'|sed 's/^.*@\(.*\):\([^\/]*\)\/\([^\/]*\)\..*/\1\/\2\/\3/')
      echo rm -rf $GOPATH/$DIR
      echo mkdir -p $(dirname $GOPATH/$DIR) 
      echo ln -s $(pwd) $GOPATH/$DIR
    - go get -v -t ./...
    - test -z "$(gofmt -s -l . | tee /dev/stderr)"
    - gometalinter --deadline 30s ./...
    - go test -race -test.v ./...
deployment:
  release:
     tag: /v.*/
     commands:
     - go get github.com/mitchellh/gox
     - go get github.com/tcnksm/ghr
     - gox --osarch "linux/amd64 darwin/amd64" -ldflags "-X main.Version=$(git describe --always --dirty) -X main.Date=$BUILD_DATE" -output "dist/${CIRCLE_PROJECT_REPONAME}_{{.OS}}_{{.Arch}}"
     - ghr -t $GITHUB_TOKEN -u $CIRCLE_PROJECT_USERNAME -r $CIRCLE_PROJECT_REPONAME --replace `git describe --tags` dist/
